 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment Details | MCP Masalas</title>

  <style>
    :root {
      --accent: #c0392b;
      --accent-soft: #ffe8e4;
      --bg: #fffaf5;
      --card: #ffffff;
      --text-dark: #2c3e50;
      --text-soft: #7f8c8d;
      --radius-lg: 18px;
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text-dark);
      padding: 1.2rem 1rem 2rem;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 900px;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
      color: var(--accent);
      text-decoration: none;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.4rem;
    }

    .subtitle {
      font-size: 0.86rem;
      color: var(--text-soft);
      margin-bottom: 0.8rem;
    }

    .steps {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .step {
      flex: 1;
      min-width: 140px;
      background: var(--card);
      border-radius: 999px;
      padding: 0.45rem 0.7rem;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      box-shadow: var(--shadow-soft);
    }

    .step span {
      font-weight: 600;
    }

    .step.done {
      background: var(--accent);
      color: #fff;
    }

    .step.current {
      border: 1px dashed var(--accent);
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 0.9rem 1rem;
      margin-bottom: 0.9rem;
    }

    .card h2 {
      font-size: 1rem;
      margin-bottom: 0.4rem;
    }

    .card-sub {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 0.5rem;
    }

    .amount-box {
      background: var(--accent-soft);
      border-radius: 12px;
      padding: 0.6rem 0.7rem;
      display: inline-flex;
      align-items: baseline;
      gap: 0.4rem;
      margin-bottom: 0.4rem;
    }

    .amount-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .amount-value {
      font-size: 1rem;
      font-weight: 700;
    }

    .note {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-top: 0.2rem;
    }

    .payment-options {
      margin-top: 0.6rem;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 0.7rem;
    }

    @media (max-width: 800px) {
      .payment-options {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .section-title {
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
      font-weight: 600;
    }

    .upi-details {
      font-size: 0.85rem;
    }

    .upi-id-box {
      background: #fdf0ec;
      border-radius: 12px;
      padding: 0.5rem 0.6rem;
      margin-top: 0.3rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
    }

    .upi-id {
      font-family: "Menlo", "Consolas", monospace;
      word-break: break-all;
    }

    .copy-btn {
      border: none;
      border-radius: 999px;
      padding: 0.3rem 0.7rem;
      font-size: 0.75rem;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
    }

    .qr-box {
      margin-top: 0.6rem;
      text-align: center;
      font-size: 0.78rem;
    }

    .qr-box img {
      max-width: 180px;
      width: 100%;
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      background: #fff;
    }

    .payment-methods {
      font-size: 0.85rem;
    }

    .method {
      margin-top: 0.3rem;
    }

    .method label {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
    }

    .method input {
      accent-color: var(--accent);
    }

    .btn-main {
      margin-top: 0.8rem;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 0.7rem 1rem;
      font-size: 0.95rem;
      cursor: pointer;
      background: #27ae60;
      color: #fff;
      box-shadow: 0 8px 20px rgba(39, 174, 96, 0.35);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }

    .btn-secondary {
      margin-top: 0.4rem;
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      padding: 0.6rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: #ffffff;
      color: var(--text-dark);
    }

    .small-note {
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-top: 0.3rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <a href="order.html" class="back-link">‚Üê Back to order details</a>

    <h1>Payment Details</h1>
    <p class="subtitle">
      Your order has been prepared to send on WhatsApp. Please complete the payment using any one of the options below.
    </p>

    <!-- Steps -->
    <div class="steps">
      <div class="step done">
        üìù <span>Step 1</span> Order Details
      </div>
      <div class="step done">
        üí≥ <span>Step 2</span> Payment
      </div>
      <div class="step current" id="step3">
        üì¶ <span>Step 3</span> Confirmation
      </div>
    </div>

    <!-- Amount card -->
    <section class="card">
      <h2>Amount to Pay</h2>
      <p class="card-sub">
        This is the approximate total based on your cart and delivery. Final amount will be confirmed on WhatsApp.
      </p>

      <div class="amount-box">
        <div class="amount-label">Total payable</div>
        <div class="amount-value" id="payAmount">As per WhatsApp</div>
      </div>

      <p class="note" id="amountNote">
        If you already see the exact total in WhatsApp, please pay that amount.
      </p>
    </section>

    <!-- Payment options -->
    <section class="card">
      <h2>Choose Payment Method</h2>
      <p class="card-sub">
        You can pay now using UPI or choose Cash on Delivery (if available in your area).
      </p>

      <div class="payment-options">
        <!-- LEFT: UPI details + screenshot -->
        <div>
          <div class="section-title">Pay via UPI</div>
          <div class="upi-details">
            You can scan the QR code or send directly to the UPI ID below.
          </div>

          <div class="upi-id-box">
            <div class="upi-id" id="upiIdText">mcpmasalas@upi</div>
            <button class="copy-btn" id="copyUpiBtn">Copy</button>
          </div>

          <div class="qr-box">
            <img src="sampleqr.jpeg" alt="UPI QR Code for MCP Masalas" />
            <div class="note">Scan this QR in any UPI app (PhonePe, GPay, Paytm, etc.)</div>
          </div>

          <!-- Upload payment screenshot -->
          <div class="section-title" style="margin-top:1rem;">
            Upload Payment Screenshot
          </div>
          <input
            type="file"
            id="paymentProof"
            accept="image/*"
            style="font-size:0.85rem;margin-top:0.3rem;"
          />

          <div id="proofPreview" class="qr-box" style="display:none;margin-top:0.5rem;">
            <img id="proofImg" alt="Payment screenshot preview"
                 style="max-width:200px;border-radius:14px;" />
            <div class="note">
              This screenshot will be saved with your order for admin verification.
            </div>
          </div>
        </div>

        <!-- RIGHT: Method selection -->
        <div>
          <div class="section-title">Payment Option</div>
          <div class="payment-methods">
            <div class="method">
              <label>
                <input type="radio" name="payMethod" value="upi" />
                I will pay now via UPI
              </label>
            </div>
            <div class="method">
              <label>
                <input type="radio" name="payMethod" value="cod" />
                Cash on Delivery (pay when order arrives)
              </label>
            </div>
          </div>

          <button class="btn-main" id="paymentDoneBtn">
            ‚úÖ I have completed the payment
          </button>

          <button class="btn-secondary" type="button"
                  onclick="window.location.href='index.html'">
            ‚Üê Continue shopping
          </button>

          <div class="small-note">
            After you complete the payment, tap the confirmation button. Our team will verify the payment and send final confirmation on WhatsApp.
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://kkrqcprhnafrhgjqhwrg.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrcnFjcHJobmFmcmhnanFod3JnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxOTYzNjEsImV4cCI6MjA3OTc3MjM2MX0.-udhnc4gYVwkPX8aeD8oaWCnt6VcPWIqmG6FF4rYUFk";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const BUCKET_NAME = "payment-proofs"; // üëà make sure this bucket exists

    // --- Amount from URL ---
    (function () {
      const params = new URLSearchParams(window.location.search);
      const total = params.get("total");
      const payAmountEl = document.getElementById("payAmount");
      const amountNoteEl = document.getElementById("amountNote");

      if (total && !isNaN(Number(total))) {
        payAmountEl.textContent = "‚Çπ " + Number(total).toFixed(0);
        amountNoteEl.textContent =
          "Please pay this amount via UPI or prepare exact cash for delivery.";
      }
    })();

    // --- Copy UPI ID ---
    document.getElementById("copyUpiBtn").addEventListener("click", () => {
      const upiText = document.getElementById("upiIdText").textContent.trim();
      navigator.clipboard
        .writeText(upiText)
        .then(() => alert("UPI ID copied: " + upiText))
        .catch(() =>
          alert("Could not copy. Please long press and copy manually.")
        );
    });

    // --- Screenshot preview ---
    const paymentProofInput = document.getElementById("paymentProof");
    const proofPreview = document.getElementById("proofPreview");
    const proofImg = document.getElementById("proofImg");

    if (paymentProofInput) {
      paymentProofInput.addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          proofImg.src = e.target.result;
          proofPreview.style.display = "block";
        };
        reader.readAsDataURL(file);
      });
    }

    // --- Upload to Supabase Storage ---
    async function uploadPaymentProof(orderId, file) {
      const ext = file.name.split(".").pop() || "jpg";
      const fileName = `proof-${orderId}-${Date.now()}.${ext}`;
      const filePath = `${orderId}/${fileName}`;

      const { data, error } = await supabase.storage
        .from(BUCKET_NAME)
        .upload(filePath, file, { upsert: true });

      if (error) {
        console.error("Upload Error:", error);
        alert("Upload failed: " + (error.message || "Unknown error"));
        return null;
      }

      const { data: urlData } = supabase.storage
        .from(BUCKET_NAME)
        .getPublicUrl(filePath);

      return urlData?.publicUrl || null;
    }

    // --- Main button click ---
     const paymentBtn = document.getElementById("paymentDoneBtn");

paymentBtn.addEventListener("click", async () => {
  console.log("Payment button clicked");

  const method = document.querySelector('input[name="payMethod"]:checked');
  if (!method) {
    alert("Please select a payment option first (UPI or Cash on Delivery).");
    return;
  }

  const orderIdRaw = localStorage.getItem("mcpLastOrderId");
  if (!orderIdRaw) {
    alert("Order not found. Please go back and confirm your order again.");
    return;
  }

  const orderId = Number(orderIdRaw); // make sure it's a number
  console.log("Using orderId =", orderId);

  // If UPI, require screenshot and upload
  if (method.value === "upi") {
    const file = paymentProofInput.files[0];
    if (!file) {
      alert("Please upload your payment screenshot before confirming.");
      return;
    }

    const proofUrl = await uploadPaymentProof(orderId, file);
    console.log("Uploaded proof URL =", proofUrl);

    if (!proofUrl) {
      // upload failed, already alerted
      return;
    }

    // üîÅ UPDATE orders row with payment_proof_url
    const { error: updateError } = await supabase
      .from("orders")
      .update({ payment_proof_url: proofUrl })
      .eq("id", orderId);

    if (updateError) {
      console.error("Error saving payment proof URL:", updateError);
      alert(
        "Error saving payment proof URL: " +
          (updateError.message || JSON.stringify(updateError))
      );
      return;
    }
  }

  // Save payment method for thankyou page
  localStorage.setItem("mcpLastPaymentMethod", method.value);

  // Go to final thank you page
  window.location.href = "thankyou.html";
});

  </script>
</body>
</html>
